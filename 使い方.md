# 災害用メッシュネットワーク - 使い方ガイド

## 目次
1. [セットアップ](#セットアップ)
2. [基本的な使い方](#基本的な使い方)
3. [災害時の運用方法](#災害時の運用方法)
4. [トラブルシューティング](#トラブルシューティング)

---

## セットアップ

### 1. 必要な環境
- **OS**: Windows 10/11
- **Python**: 3.8以上
- **ネットワーク**: Wi-Fiまたは有線LAN

### 2. インストール手順

```bash
# プロジェクトディレクトリに移動
cd disaster-mesh-network

# 依存パッケージのインストール
pip install -r requirements.txt
```

### 3. 起動方法

```bash
# GUIモードで起動（推奨）
python main.py

# ノード名を指定して起動
python main.py --hostname "避難所A"

# セキュアモードで起動（デジタル署名認証）
python main.py --secure

# 中継専用モードで起動（GUI非表示、低リソース消費）
python main.py --relay-only

# 中継専用モード + ノード名指定
python main.py --relay-only --hostname "中継ポイントA"
```

---

## 基本的な使い方

### ノードの起動

1. `main.py` を実行すると、自動的にメッシュネットワークに参加します
2. **ノード状態**エリアに「接続中」と表示されれば成功です

### ノード名の設定

- 画面上部の「ノード名」欄に名前を入力
- 例: 「避難所A」「田中宅」「公民館B」など
- 「ノード名変更」ボタンをクリックして確定

### 他のノードを検出

- 同じネットワーク（Wi-Fi）に接続している他のPCを自動的に検出します
- **接続中のノード**リストに表示されます
- 「更新」ボタンで手動更新も可能

### メッセージの送信

#### テキストメッセージ

1. **宛先**を選択
   - `broadcast (全員)`: すべての接続ノードに送信
   - 個別のノード名: 特定のノードにのみ送信

2. **メッセージ**欄に内容を入力
   - 例: 「水が必要です」「こちらは無事です」

3. **送信**ボタンをクリック、またはEnterキーを押す

#### ファイルの送信

1. **ファイル送信**ボタンをクリック
2. 送信したいファイルを選択
3. 自動的にチャンクに分割されて送信されます
4. 進捗は**メッセージ履歴**に表示されます

### メッセージの受信

- 受信したメッセージは**メッセージ履歴**に自動表示
- タイムスタンプと送信元ノードIDが表示されます
- ファイルは `received_files` フォルダに自動保存

---

## 災害時の運用方法

### 想定シナリオ1: 避難所間の連絡

**状況**: 携帯電話の基地局が破壊され、インターネットが使えない

**対処**:
1. 各避難所にノートPCまたはタブレットを配置
2. 全PCで本ソフトウェアを起動
3. ノード名を「〇〇避難所」に設定
4. 安否情報や物資情報を共有

**メッセージ例**:
```
[避難所A] 水が不足しています。支援をお願いします。
[避難所B] こちらには毛布が余っています。取りに来てください。
[避難所C] 負傷者が3名います。医療支援を求めます。
```

### 想定シナリオ2: 近隣住民の安否確認

**状況**: 地震発生直後、携帯が繋がらない

**対処**:
1. 各家庭のPCでソフトを起動
2. ノード名を「〇〇さん宅」に設定
3. 「無事です」「助けが必要です」などを送信
4. 中間地点の家が自動的に中継してくれる

### 想定シナリオ3: 大規模停電時の情報共有

**状況**: 停電でテレビ・ラジオが使えない

**対処**:
1. ノートPCやタブレット（バッテリー駆動）で起動
2. 現地の最新情報を共有
   - 「〇〇地区は通電しました」
   - 「△△道路は通行可能です」
   - 「□□スーパーが営業しています」

---

## トラブルシューティング

### ノードが検出されない

**原因1**: ファイアウォールがブロックしている

**対処**:
```
1. Windowsファイアウォールの設定を開く
2. 「アプリによる通信を許可」を選択
3. Pythonまたはこのプログラムを許可リストに追加
```

**原因2**: 異なるWi-Fiネットワークに接続

**対処**:
- すべてのPCを同じWi-Fiネットワークに接続
- ルーターが停止している場合は、1台をホットスポット（アクセスポイント）にする

**原因3**: Wi-Fiがオフになっている

**対処**:
```
1. Windows設定 → ネットワークとインターネット
2. Wi-Fiをオンにする
3. ソフトを再起動
```

### メッセージが届かない

**症状**: 送信したが相手に届いていない

**原因**: 中継ノードがいない、または経路が不安定

**対処**:
1. 接続ノード数を確認（0台の場合は検出できていない）
2. 中間地点に中継用のPCを配置
3. 距離を近づける（Wi-Fi範囲は50-100m程度）

### ファイル転送が途中で止まる

**原因**: ネットワークが不安定、またはノードが切断された

**対処**:
1. 再度ファイルを送信
2. ファイルサイズが大きい場合は分割して送信
3. 中継ノードを増やす

### プログラムが起動しない

**エラー**: `ModuleNotFoundError: No module named 'Crypto'`

**対処**:
```bash
pip install pycryptodome
```

**エラー**: `OSError: [WinError 10048] 通常、各ソケット アドレスに対してプロトコル、ネットワーク アドレス、またはポートのどれか 1 つのみを使用できます。`

**原因**: すでに別のインスタンスが起動している

**対処**:
1. タスクマネージャーでPythonプロセスを終了
2. プログラムを再起動

---

## 高度な使い方

### 中継専用ノードの設置

**目的**: より広範囲をカバーする

**方法**:
1. 中継地点にPCを配置（自動販売機の横、公園のベンチなど）
2. モバイルバッテリーで給電
3. **中継専用モード**で起動（GUI非表示、低リソース消費）

```bash
# 中継専用モードで起動
python main.py --relay-only --hostname "中継ポイントA"
```

**中継専用モードの特徴**:
- GUI完全非表示でCPU・メモリ使用量を最小化
- バッテリー持続時間が通常モードの約1.5-2倍
- 30秒ごとに統計情報を表示（接続ノード数、中継メッセージ数）
- Ctrl+Cで安全に終了可能

### セキュアモード（デジタル署名認証）

**重要**: 標準モードでは共有鍵を知っている悪意のあるユーザーがなりすまし可能です。セキュアモードを使用することを強く推奨します。

**セキュアモードで起動**:
```bash
python main.py --secure
```

**セキュアモードの特徴**:
- **公開鍵暗号方式**: 各ノードが独自の鍵ペアを持つ
- **デジタル署名**: すべてのメッセージに送信者の署名が付与
- **なりすまし防止**: 署名が無効なメッセージは自動的に破棄
- **信頼スコアシステム**: 不審なノードを自動的に検出・ブロック

**初回起動時**:
- 自動的に鍵ペアが生成されます（`keys/` ディレクトリに保存）
- `<node_id>_private.pem`: 秘密鍵（厳重に保管）
- `<node_id>_public.pem`: 公開鍵（他ノードと共有）

**セキュリティ上の注意**:
- 秘密鍵ファイルは絶対に他人に渡さない
- 秘密鍵が漏洩した場合は鍵ファイルを削除して再生成

### 暗号化キーの変更（共有鍵方式）

標準モード使用時、デフォルトの共有キーを変更する場合:

1. `crypto_utils.py` を開く
2. 以下の行を変更:
```python
def __init__(self, shared_key: str = "disaster-mesh-2024"):
```

3. すべてのノードで同じキーを使用する必要があります

**注意**: セキュアモードではこの設定は不要です

### ログの確認

プログラムはコンソールにログを出力します:
- `[ノード検出]`: 新しいノードを発見
- `[送信]`: メッセージ送信成功
- `[受信]`: メッセージ受信
- `[ファイル受信]`: ファイルチャンク受信

---

## よくある質問

**Q: インターネットがなくても本当に使えますか？**

A: はい。このソフトはWi-Fiの「ローカル通信」機能のみを使用します。インターネット接続は一切不要です。

**Q: スマートフォンでも使えますか？**

A: 現在はWindows PC専用です。将来的にAndroid/iOS版も開発予定です。

**Q: 何台まで接続できますか？**

A: 理論上は最大50ノードまで。実際は10-20ノードが安定動作の目安です。

**Q: バッテリーの持続時間は？**

A: ノートPCの場合、通常2-4時間程度。省電力設定で延長可能です。

**Q: 通信範囲は？**

A: Wi-Fiの到達距離に依存します。屋外で約50-100メートル、建物内で約30メートルが目安です。

**Q: セキュリティは大丈夫？**

A: すべての通信はAES-256で暗号化されています。さらに、`--secure` オプションでデジタル署名認証を有効化することで、なりすましや改ざんを防止できます。災害時の重要通信にはセキュアモードの使用を強く推奨します。

**Q: 悪意のあるユーザーが偽のメッセージを送ってきたら？**

A: セキュアモード（`--secure`）を使用している場合、デジタル署名のないメッセージや署名が無効なメッセージは自動的に破棄されます。さらに、不審な動きをするノードは信頼スコアが下がり、自動的にブロックされます。

---

## サポート

バグ報告や機能要望は、プロジェクトのGitHubリポジトリまでお願いします。

---

**災害に備えて、平時から動作確認をしておくことをお勧めします。**
