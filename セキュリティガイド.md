# セキュリティガイド - 災害用メッシュネットワーク

## 概要

災害時のような緊急事態では、悪意のあるユーザーが偽の情報を流したり、通信を妨害したりする可能性があります。本システムは、そのような脅威からネットワークを保護するための複数のセキュリティ機能を提供しています。

---

## 脅威モデル

### 想定される攻撃

1. **盗聴（Eavesdropping）**
   - 攻撃者が通信内容を傍受
   - 個人情報や機密情報の漏洩

2. **なりすまし（Impersonation）**
   - 攻撃者が信頼されたノードを装う
   - 偽の避難所情報や救助情報を拡散

3. **改ざん（Tampering）**
   - メッセージの内容を書き換え
   - 「水がある」→「水がない」などの情報操作

4. **DoS攻撃（Denial of Service）**
   - 大量のメッセージを送信してネットワークを麻痺
   - 重要な通信を妨害

5. **中間者攻撃（Man-in-the-Middle）**
   - 中継ノードを装って通信を傍受・改ざん

---

## セキュリティ機能

### 1. 暗号化（すべてのモードで有効）

**実装**: AES-256-CBC

**保護対象**: 盗聴攻撃

**動作**:
- すべての通信データを暗号化
- 第三者が内容を読み取ることは不可能

**制限**:
- 標準モードでは共有鍵方式のため、鍵を知っている人は誰でも復号可能
- 内部者による攻撃には無力

### 2. デジタル署名（セキュアモードのみ）

**実装**: ECDSA (楕円曲線デジタル署名アルゴリズム)

**保護対象**: なりすまし、改ざん

**動作**:
1. 各ノードが公開鍵・秘密鍵ペアを持つ
2. 送信者が秘密鍵でメッセージに署名
3. 受信者が公開鍵で署名を検証
4. 署名が無効な場合、メッセージを破棄

**利点**:
- なりすましが不可能（秘密鍵を持つノードのみ署名可能）
- メッセージの改ざんを検出

### 3. 信頼スコアシステム（セキュアモードのみ）

**実装**: 動的な信頼度評価

**保護対象**: 不審なノードの検出・排除

**動作**:
- 各ノードに0-100の信頼スコアを付与
- 正常な通信で+1、異常な動作で-20～-30
- スコアが20未満のノードからのメッセージは中継拒否
- スコアが10未満のノードは信頼リストから削除

**信頼スコアの増減**:
| イベント | スコア変化 |
|---------|----------|
| 署名検証成功 | +1 |
| 署名検証失敗 | -20 |
| 送信元IDと署名者ID不一致 | -30 |

### 4. TTL制限（すべてのモードで有効）

**実装**: Time To Live (最大ホップ数)

**保護対象**: DoS攻撃、無限ループ

**動作**:
- メッセージは最大20ホップまで転送可能
- 1ホップごとにTTLを1減算
- TTL=0になったメッセージは破棄

**効果**:
- 無限にループするメッセージを防止
- ネットワーク負荷を制限

### 5. 重複メッセージ検出（すべてのモードで有効）

**実装**: メッセージIDキャッシュ

**保護対象**: リプレイ攻撃、無限ループ

**動作**:
- 受信したメッセージIDをキャッシュ
- 同じIDのメッセージは2度処理しない

---

## モード比較

| 機能 | 標準モード | セキュアモード |
|------|-----------|--------------|
| AES暗号化 | ✅ | ✅ |
| デジタル署名 | ❌ | ✅ |
| なりすまし防止 | ❌ | ✅ |
| 改ざん検出 | ❌ | ✅ |
| 信頼スコアシステム | ❌ | ✅ |
| TTL制限 | ✅ | ✅ |
| 重複検出 | ✅ | ✅ |

**推奨**: 災害時の重要通信にはセキュアモードを使用

---

## セキュアモードの使い方

### 起動

```bash
# セキュアモードで起動
python main.py --secure
```

### 初回起動時

1. 鍵ペアが自動生成されます
   ```
   keys/
   ├── <node_id>_private.pem  # 秘密鍵（厳重に保管）
   └── <node_id>_public.pem   # 公開鍵
   ```

2. コンソールに以下のメッセージが表示されます:
   ```
   [鍵生成] 鍵ペアを生成しました
     秘密鍵: keys/<node_id>_private.pem
     公開鍵: keys/<node_id>_public.pem
   [認証] デジタル署名認証が有効化されました
   ```

### 鍵の管理

**秘密鍵（private.pem）**:
- ⚠️ **絶対に他人に渡さない**
- ⚠️ **バックアップを安全な場所に保管**
- 漏洩した場合、なりすまされる可能性あり

**公開鍵（public.pem）**:
- 他のノードと共有しても安全
- メッセージの署名検証に使用

### 信頼リストの確認

信頼されたノードは `trusted_nodes.json` に保存されます:

```json
{
  "trusted_nodes": {
    "node-abc123...": "-----BEGIN PUBLIC KEY-----..."
  },
  "trust_scores": {
    "node-abc123...": 85
  }
}
```

---

## セキュリティのベストプラクティス

### 1. セキュアモードを使用する

**理由**: 標準モードでは共有鍵を知っている人が誰でもなりすまし可能

**対策**: `--secure` オプションで起動

### 2. 秘密鍵を厳重に管理

**危険な行為**:
- 秘密鍵をUSBメモリで持ち歩く
- 秘密鍵をメールで送信
- 秘密鍵をクラウドにアップロード

**推奨**:
- PCのローカルディスクに保存
- 暗号化されたバックアップを作成
- パスワード付きUSBに保存（紛失注意）

### 3. 不審なノードを監視

**監視ポイント**:
- 署名検証失敗が多発するノード
- 信頼スコアが急激に低下するノード
- 大量のメッセージを送信するノード

**対処**:
- コンソールログを確認
- 信頼スコアが低いノードは自動的にブロック

### 4. 定期的に信頼リストをクリーンアップ

```bash
# プログラム内で自動実行されますが、手動でも可能
```

### 5. ネットワークを分離

**推奨構成**:
```
[一般ノード] ←→ [一般ノード]
     ↓
[中継ノード（セキュア）]
     ↓
[重要拠点（避難所本部など）]
```

重要拠点は必ずセキュアモードを使用

---

## 攻撃シナリオと対策

### シナリオ1: なりすまし攻撃

**攻撃**:
- 攻撃者が「避難所A」を装って偽の情報を送信
- 「避難所Aには水がありません」（実際はある）

**標準モードでの結果**:
- ❌ 防御不可能（共有鍵を知っていれば誰でも送信可能）

**セキュアモードでの結果**:
- ✅ 攻撃者は「避難所A」の秘密鍵を持っていないため署名不可
- 署名のないメッセージは自動的に破棄
- 攻撃者の信頼スコアが-20され、ブロック対象に

### シナリオ2: メッセージ改ざん

**攻撃**:
- 中継ノードがメッセージを傍受
- 「水がある」→「水がない」に書き換え

**標準モードでの結果**:
- ❌ 暗号化されているため改ざんは困難だが、検出不可

**セキュアモードでの結果**:
- ✅ デジタル署名が無効になる
- 改ざんされたメッセージは受信者側で破棄
- 中継ノードの信頼スコアが-30

### シナリオ3: DoS攻撃

**攻撃**:
- 攻撃者が1秒に100個のメッセージを送信
- ネットワーク全体が麻痺

**すべてのモードでの対策**:
- ✅ TTL=20でメッセージの拡散範囲を制限
- ✅ 重複メッセージは処理されない
- ✅ セキュアモードでは信頼スコアが急速に低下し、自動ブロック

### シナリオ4: 中間者攻撃

**攻撃**:
- 攻撃者が中継ノードを装う
- 通信を傍受してメッセージを読む

**標準モードでの結果**:
- ⚠️ 暗号化されているため内容は読めないが、共有鍵があれば復号可能

**セキュアモードでの結果**:
- ✅ メッセージは暗号化されている
- ✅ さらにデジタル署名で送信元を検証可能
- ✅ 偽の中継ノードは署名検証で検出される

---

## セキュリティ監査

### ログの確認

**重要なログメッセージ**:

```
[認証失敗] 署名が無効なメッセージを受信: abc12345...
[認証失敗] 送信元IDと署名者IDが不一致
[信頼管理] ノード abc12345... のスコアを更新: 20
[中継拒否] ノード abc12345... の信頼スコアが低いため中継しません
```

**対処**:
- 連続して認証失敗が発生する場合は攻撃の可能性
- 信頼スコアが急激に低下するノードを調査

### 信頼リストの確認

```bash
# trusted_nodes.json を確認
cat trusted_nodes.json
```

**チェックポイント**:
- 見覚えのないノードIDがないか
- 信頼スコアが異常に低いノードがないか

---

## 既知の制限事項

### 1. 初回接続時の脆弱性

**問題**:
初めて接続するノードは公開鍵が未知のため、最初のメッセージで公開鍵を受け取る

**リスク**:
攻撃者が最初に接続すれば、偽の公開鍵を登録できる

**対策**:
- 信頼できるノードのみを接続許可
- 物理的に近い場所で初期セットアップ
- 公開鍵のフィンガープリントを事前に共有

### 2. 秘密鍵の保護

**問題**:
秘密鍵ファイルがPCに平文で保存される

**リスク**:
PCが盗難された場合、秘密鍵が漏洩

**対策**:
- PCにログインパスワードを設定
- ディスク暗号化（BitLocker等）を有効化
- 使用後は秘密鍵を削除（緊急時以外）

### 3. サイドチャネル攻撃

**問題**:
通信の頻度やタイミングから情報が漏洩する可能性

**対策**:
- 現時点では対策なし（将来的にダミートラフィックを実装予定）

---

## 緊急時の対応

### 秘密鍵が漏洩した場合

1. **即座にノードを停止**
   ```bash
   Ctrl+C
   ```

2. **鍵ファイルを削除**
   ```bash
   del keys\<node_id>_private.pem
   del keys\<node_id>_public.pem
   ```

3. **新しいノードIDで再起動**
   - プログラムを再起動すると新しいノードIDが生成される
   - 新しい鍵ペアが自動生成される

### 攻撃を受けている場合

1. **ログを確認**
   - 認証失敗メッセージが多発していないか

2. **信頼リストをクリア**
   ```bash
   del trusted_nodes.json
   ```

3. **セキュアモードで再起動**
   ```bash
   python main.py --secure
   ```

---

## まとめ

| セキュリティレベル | 使用モード | 適用場面 |
|-------------------|----------|---------|
| 低 | 標準モード | テスト、練習 |
| 中 | 標準モード + 鍵変更 | 小規模避難所 |
| **高** | **セキュアモード** | **災害時の重要通信** |

**推奨**: 災害時には必ずセキュアモード（`--secure`）を使用してください。

---

## 参考文献

- [ECDSA - 楕円曲線デジタル署名アルゴリズム](https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm)
- [AES - Advanced Encryption Standard](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.197.pdf)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
